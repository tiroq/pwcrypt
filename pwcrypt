#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat >&2 <<'USAGE'
Usage:
  pwcrypt enc [-i FILE] [-o FILE]
  pwcrypt dec [-i FILE] [-o FILE]

  Without -i reads from stdin (for enc with tty will prompt for secret interactively).
  Without -o writes to stdout.

Options:
  -i FILE   input file (default stdin)
  -o FILE   output file (default stdout)

Notes:
  • Uses AES-256-CBC + PBKDF2 with 200k iterations, salt, Base64.
  • Master password is requested via /dev/tty and doesn't appear in shell history.
  • Store output data entirely (starts with "U2FsdGVkX1..." due to Base64).
USAGE
}

openssl_enc_args=(
  enc -aes-256-cbc          # can be replaced with -aes-256-gcm if your OpenSSL supports it
  -salt                     # adds random salt
  -pbkdf2                   # modern key derivation
  -iter 200000              # PBKDF2 strengthening (~200k iterations)
  -md sha256                # hash function for PBKDF2
  -a                        # Base64 (convenient for storage/copying)
)

cmd="${1:-}"
[[ -z "$cmd" ]] && { usage; exit 1; }
shift || true

in="/dev/stdin"
out="/dev/stdout"

# Parsing -i/-o
while [[ $# -gt 0 ]]; do
  case "$1" in
    -i) shift; in="${1:-}"; [[ -z "$in" ]] && { echo "Missing -i value" >&2; exit 2; } ;;
    -o) shift; out="${1:-}"; [[ -z "$out" ]] && { echo "Missing -o value" >&2; exit 2; } ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown arg: $1" >&2; usage; exit 2 ;;
  esac
  shift || true
done

# Request master password via /dev/tty
if [[ -t 2 ]]; then
  read -r -s -p "Master passphrase: " MASTER < /dev/tty
  echo >&2
else
  # if no tty (pipe), still try to read from tty if available
  if [[ -r /dev/tty ]]; then
    read -r -s -p "Master passphrase: " MASTER < /dev/tty
    echo >&2
  else
    echo "Cannot read master passphrase (no TTY). Run interactively." >&2
    exit 1
  fi
fi
export MASTER

case "$cmd" in
  enc)
    if [[ "$in" == "/dev/stdin" && -t 0 ]]; then
      # No input file and stdin is terminal: ask for secret interactively
      read -r -s -p "Secret to encrypt: " SECRET < /dev/tty
      echo >&2
      printf '%s' "$SECRET" | \
        openssl "${openssl_enc_args[@]}" -pass env:MASTER > "$out"
      unset SECRET
    else
      # Take from file or from stdin pipeline
      openssl "${openssl_enc_args[@]}" -pass env:MASTER -in "$in" -out "$out"
    fi
    ;;

  dec)
    openssl "${openssl_enc_args[@]}" -d -pass env:MASTER -in "$in" -out "$out"
    ;;

  *)
    echo "Unknown command: $cmd" >&2
    usage
    exit 2
    ;;
esac

# Clear master password variable
unset MASTER
